<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SignBridge (MediaPipe ‚Üí Nemotron ‚Üí Speech)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background:#f8f9fa;}
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .log { background: #fafafa; border: 1px dashed #ccc; padding: 8px; height: 180px; overflow: auto; font: 12px/1.35 ui-monospace, SFMono-Regular, monospace; white-space: pre-wrap;}
    video, canvas { width: 100%; border-radius: 12px; background:#000; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #333; background: #fff; cursor: pointer; transition: background .2s;}
    button:hover { background:#eaeaea; }
    .row { display:flex; gap: 8px; align-items:center; margin: 8px 0; flex-wrap: wrap; }
    .pill { padding: 4px 8px; border-radius: 9999px; background:#eef; font-weight:600 }
    .small { font-size: 12px; color: #555; }
    select, input[type="range"] { margin-left: 6px; }
  </style>
</head>
<body>
  <h1>SignBridge ‚Äî Camera ‚Üí Nemotron ‚Üí Speech</h1>

  <div class="grid">
    <!-- LEFT: CAMERA -->
    <div class="card">
      <h2>Live Camera</h2>
      <div class="row">
        <button id="startBtn">Start Camera</button>
        <label><input type="checkbox" id="mirror" checked /> Mirror preview</label>
        <label><input type="checkbox" id="debugToggle" /> Debug</label>
      </div>
      <div class="row small">
        <span>Detected Pose (smoothed): <span class="pill" id="pose">‚Äî</span></span>
        <span>Raw (current frame): <span class="pill" id="poseRaw">‚Äî</span></span>
      </div>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>

      <div class="log" id="log"></div>
    </div>

    <!-- RIGHT: DEMO + TTS -->
    <div class="card">
      <h2>What We Recognize (Demo Set)</h2>
      <ul>
        <li><b>OPEN_PALM</b> ‚Äî all 5 fingers extended</li>
        <li><b>FIST</b> ‚Äî no fingers extended</li>
        <li><b>THUMBS_UP</b> ‚Äî thumb extended, other fingers curled</li>
        <li><b>ONE‚ÄìFIVE</b> ‚Äî finger count (index..pinky)</li>
      </ul>
      <p class="small">
        Good lighting & clear hand positioning help recognition accuracy.<br/>
        We analyze <b>finger joint angles</b> and <b>palm width</b>, then smooth results across frames.
      </p>

      <hr/>
      <h3>Nemotron Agent Output</h3>
      <div class="row">
        <button id="sendBtn">Send to Agent</button>
        <span>Agent Output: <span class="pill" id="english">‚Äî</span></span>
      </div>

      <div class="row">
        <label><input type="checkbox" id="autoSpeak" checked /> Speak automatically</label>
        <label>Voice:
          <select id="voiceSelect"></select>
        </label>
      </div>
      <div class="row">
        <label>Rate:
          <input type="range" id="rate" min="0.5" max="1.5" step="0.05" value="1.0">
          <span class="small" id="rateVal">1.0</span>
        </label>
        <label>Pitch:
          <input type="range" id="pitch" min="0.5" max="1.8" step="0.1" value="1.0">
          <span class="small" id="pitchVal">1.0</span>
        </label>
      </div>
      <div class="row">
        <button id="speakBtn" title="Replay last agent response">üîä Speak Last</button>
        <button id="stopBtn" title="Stop speaking">‚èπÔ∏è Stop</button>
      </div>
    </div>
  </div>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    const API = "http://localhost:8000";
    const logEl = document.getElementById("log");
    const poseEl = document.getElementById("pose");
    const poseRawEl = document.getElementById("poseRaw");
    const englishEl = document.getElementById("english");
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const ctx = overlay.getContext("2d");
    const mirrorCb = document.getElementById("mirror");
    const debugCb = document.getElementById("debugToggle");
    const autoSpeak = document.getElementById("autoSpeak");
    const voiceSelect = document.getElementById("voiceSelect");
    const speakBtn = document.getElementById("speakBtn");
    const stopBtn = document.getElementById("stopBtn");
    const rate = document.getElementById("rate");
    const pitch = document.getElementById("pitch");
    const rateVal = document.getElementById("rateVal");
    const pitchVal = document.getElementById("pitchVal");
    const log = (m)=>{ logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };

    // ---------- TTS ----------
    let lastUtteranceText = "";
    let voices = [];
    function populateVoices() {
      voices = window.speechSynthesis.getVoices();
      const was = voiceSelect.value;
      voiceSelect.innerHTML = "";
      const sorted = voices.slice().sort((a,b)=>{
        const ae=(a.lang||"").startsWith("en")?0:1;
        const be=(b.lang||"").startsWith("en")?0:1;
        if(ae!==be) return ae-be;
        return (a.name||"").localeCompare(b.name||"");
      });
      for (const v of sorted) {
        const opt=document.createElement("option");
        opt.value=v.name; opt.textContent=`${v.name} (${v.lang})${v.default?" ‚Äî default":""}`;
        voiceSelect.appendChild(opt);
      }
      if(was) voiceSelect.value=was;
      if(!voiceSelect.value&&sorted.length){
        const eng=sorted.find(v=>v.lang&&v.lang.startsWith("en"));
        voiceSelect.value=(eng&&eng.name)||sorted[0].name;
      }
    }
    populateVoices();
    if(typeof window.speechSynthesis!=="undefined"){
      window.speechSynthesis.onvoiceschanged=populateVoices;
    }
    function speak(text){
      if(!text||!window.speechSynthesis)return;
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      const selected=voices.find(v=>v.name===voiceSelect.value);
      if(selected)u.voice=selected;
      u.rate=parseFloat(rate.value||"1.0");
      u.pitch=parseFloat(pitch.value||"1.0");
      u.onstart=()=>log(`üîä speaking: "${text}"`);
      u.onend=()=>log("üîá done speaking.");
      window.speechSynthesis.speak(u);
    }
    rate.addEventListener("input",()=>{rateVal.textContent=rate.value;});
    pitch.addEventListener("input",()=>{pitchVal.textContent=pitch.value;});
    speakBtn.addEventListener("click",()=>{if(lastUtteranceText)speak(lastUtteranceText);});
    stopBtn.addEventListener("click",()=>window.speechSynthesis.cancel());

    // ---------- Geometry helpers ----------
    function sub(a,b){return{x:a.x-b.x,y:a.y-b.y};}
    function dot(a,b){return a.x*b.x+a.y*b.y;}
    function mag(v){return Math.hypot(v.x,v.y);}
    function norm(v){const m=mag(v)||1e-6;return{x:v.x/m,y:v.y/m};}
    function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
    function angle(a,p,b){const v1=norm(sub(a,p)),v2=norm(sub(b,p));return Math.acos(Math.min(1,Math.max(-1,dot(v1,v2))));}

    const FINGER_CFG=[{mcp:2,pip:3,tip:4},{mcp:5,pip:6,tip:8},{mcp:9,pip:10,tip:12},{mcp:13,pip:14,tip:16},{mcp:17,pip:18,tip:20}];
    function fingerExtendedByAngle(l,c){const a=l[c.mcp],p=l[c.pip],b=l[c.tip];if(!a||!p||!b)return false;return angle(a,p,b)>2.3;}
    function thumbExtended(l){const a=l[2],p=l[3],b=l[4];if(!a||!p||!b)return false;const i=l[5],pk=l[17];const w=(i&&pk)?dist(i,pk):0.08;return angle(a,p,b)>2.2&&Math.abs(b.x-(i?i.x:b.x))>0.12*w;}
    function classifyRawPose(l){const e={THUMB:thumbExtended(l),INDEX:fingerExtendedByAngle(l,FINGER_CFG[1]),MIDDLE:fingerExtendedByAngle(l,FINGER_CFG[2]),RING:fingerExtendedByAngle(l,FINGER_CFG[3]),PINKY:fingerExtendedByAngle(l,FINGER_CFG[4])};const c=["INDEX","MIDDLE","RING","PINKY"].reduce((n,k)=>n+(e[k]?1:0),0);
      if(!e.INDEX&&!e.MIDDLE&&!e.RING&&!e.PINKY&&!e.THUMB)return"FIST";
      if(!e.INDEX&&!e.MIDDLE&&!e.RING&&!e.PINKY&&e.THUMB)return"THUMBS_UP";
      if(e.INDEX&&e.MIDDLE&&e.RING&&e.PINKY&&e.THUMB)return"OPEN_PALM";
      if(c===1)return"ONE";if(c===2)return"TWO";if(c===3)return"THREE";if(c===4)return"FOUR";return c===0?(e.THUMB?"THUMBS_UP":"FIST"):"FIVE";}
    const recent=[];function smoothPose(p){if(!p){recent.length=0;return null;}recent.push(p);if(recent.length>7)recent.shift();const f={};for(const x of recent)f[x]=(f[x]||0)+1;return Object.entries(f).reduce((a,b)=>b[1]>a[1]?b:a)[0];}

    // ---------- MediaPipe Hands ----------
    let camera=null;
    const hands=new Hands({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({maxNumHands:1,minDetectionConfidence:0.6,minTrackingConfidence:0.6,modelComplexity:0});
    hands.onResults((r)=>{
      overlay.width=video.videoWidth||640;overlay.height=video.videoHeight||360;
      ctx.save();ctx.clearRect(0,0,overlay.width,overlay.height);
      if(mirrorCb.checked){ctx.translate(overlay.width,0);ctx.scale(-1,1);}
      if(r.multiHandLandmarks&&r.multiHandLandmarks.length){
        const l=r.multiHandLandmarks[0];
        if(debugCb.checked){window.drawConnectors(ctx,l,window.HAND_CONNECTIONS,{color:'#0af',lineWidth:2});window.drawLandmarks(ctx,l,{color:'#f40',radius:2});}
        const raw=classifyRawPose(l);const s=smoothPose(raw);
        poseRawEl.textContent=raw||"‚Äî";poseEl.textContent=s||"‚Äî";
      }else{smoothPose(null);poseRawEl.textContent="‚Äî";poseEl.textContent="‚Äî";}
      ctx.restore();
    });
    document.getElementById("startBtn").onclick=async()=>{
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
        video.srcObject=stream;await video.play();
        camera=new window.Camera(video,{onFrame:async()=>{await hands.send({image:video});},width:640,height:360});
        camera.start();log("Camera started. Show your hand!");
      }catch(err){log("Camera error: "+err);alert("Could not access camera.");}
    };

    // ---------- Backend + Speak ----------
    document.getElementById("sendBtn").onclick=async()=>{
      const gloss=(poseEl.textContent||"").trim();
      if(!gloss||gloss==="‚Äî"){alert("Show a pose first.");return;}
      try{
        const r=await fetch(`${API}/translate/gloss`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gloss})});
        if(!r.ok){log(`HTTP ${r.status}`);alert("Backend error.");return;}
        const d=await r.json();
        const spoken=d.english||"‚Äî";
        englishEl.textContent=spoken;lastUtteranceText=spoken;
        if(autoSpeak.checked&&spoken!=="‚Äî")speak(spoken);
        log(`gloss=${gloss} ‚Üí "${spoken}"`);
      }catch(err){log("JS error: "+err?.message);}
    };
  </script>
</body>
</html>